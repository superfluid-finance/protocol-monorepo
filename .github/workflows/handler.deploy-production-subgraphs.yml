# Handler Workflow Summary
# This handler workflow file can be used to deploy our subgraphs.
# It can be used to one network, or all networks to either
# self-hosted nodes, the Graph Hosted Service and Satsuma.

name: Handler | Deploy Production Subgraph
env:
  GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

on:
  workflow_dispatch:
    inputs:
      vendor:
        required: true
        description: "Where to deploy subgraph to; superfluid, graph, or satsuma"
        type: string
      release_branch:
        required: false
        type: string
        description: 'The subgraph release: feature, dev, v1. Required for self-hosted and Te Graph. '
      network:
        required: true
        type: string
        description: 'The network you want to deploy to (matic, xdai, eth-mainnet, etc.) or `all` for all networks.'         

jobs:
  build-and-test-local-subgraph:
    uses: ./.github/workflows/call.test-local-subgraph.yml
    name: Run Subgraph Unit and Integration Tests

  build-and-test-local-subgraph-against-previous-sdk-core-releases:
    uses: ./.github/workflows/call.test-subgraph-on-previous-sdk-core-versions.yml
    name: Test Local Subgraph against SDK-Core previous and current releases
    with:
      subgraph-release: ''
      subgraph-endpoint: http://localhost:8000/subgraphs/name/superfluid-test

  deploy-hosted-service-subgraph:
    uses: ./.github/workflows/call.deploy-subgraph.yml
    needs: [ 
            build-and-test-local-subgraph
           , build-and-test-local-subgraph-against-previous-sdk-core-releases
           ]
    name: Deploy The Graph Hosted Subgraph
    with:
      release_branch: ${{ github.event.inputs.release_branch }}
      network: ${{ github.event.inputs.network }}
      vendor: "graph"
    secrets:
      THE_GRAPH_ACCESS_TOKEN: ${{ secrets.THE_GRAPH_ACCESS_TOKEN }}

  deploy-satsuma-subgraph:
    uses: ./.github/workflows/call.deploy-subgraph.yml
    needs: [ 
            build-and-test-local-subgraph
           , build-and-test-local-subgraph-against-previous-sdk-core-releases
           ]
    name: Deploy Satsuma Hosted Subgraph
    with:
      network: ${{ github.event.inputs.network }}
      vendor: "satsuma"
    secrets:
      SATSUMA_DEPLOY_KEY: ${{ secrets.SATSUMA_DEPLOY_KEY }}

  deploy-self-hosted-subgraph:
    uses: ./.github/workflows/call.deploy-subgraph.yml
    needs: [ 
            build-and-test-local-subgraph
           , build-and-test-local-subgraph-against-previous-sdk-core-releases
           ]
    name: Deploy Superfluid Self Hosted Subgraph
    with:
      release_branch: "v1"
      network: ${{ github.event.inputs.network }}
      vendor: "superfluid"
    secrets:
      SUBGRAPH_URL_TEMPLATE: ${{ secrets.SUBGRAPH_URL_TEMPLATE }}
      SUPERFLUID_IPFS_API: ${{ secrets.SUPERFLUID_IPFS_API }}      
