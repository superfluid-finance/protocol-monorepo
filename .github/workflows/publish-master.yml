name: Publish master branch

on:
  push:
    branches: ["master", "process_176_setup_branching_policy"]

jobs:

  npm-publish-master:
    name: NPM publish master branch package

    runs-on: ubuntu-latest

    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPMJS_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.SUPERFLUID_GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
          registry-url: https://registry.npmjs.org/

      - name: Check package versions
        run: |
          PUBLISHED_ETHEREUM_CONTRACTS_VERSION=`npm show @superfluid-finance/ethereum-contracts version`
          NEW_ETHEREUM_CONTRACTS_VERSION=`jq .version packages/ethereum-contracts/package.json`
          if [ "$PUBLISHED_ETHEREUM_CONTRACTS_VERSION" != "$NEW_ETHEREUM_CONTRACTS_VERSION" ];then
            echo "PUBLISH_ETHEREUM_CONTRACTS=1" >> $GITHUB_ENV
            echo ethereum-contracts: $PUBLISHED_ETHEREUM_CONTRACTS_VERSION -> NEW_ETHEREUM_CONTRACTS_VERSION
          else
            echo ethereum-contracts: $PUBLISHED_ETHEREUM_CONTRACTS_VERSION
          fi
          PUBLISHED_JS_SDK_VERSION=`npm show @superfluid-finance/js-sdk version`
          NEW_JS_SDK_VERSION=`jq .version packages/js-sdk/package.json`
          if [ "$PUBLISHED_JS_SDK_VERSION" != "$NEW_JS_SDK_VERSION" ];then
            echo "PUBLISH_JS_SDK=1" >> $GITHUB_ENV
            echo ethereum-contracts: $PUBLISHED_JS_SDK_VERSION -> NEW_JS_SDK_VERSION
          else
            echo ethereum-contracts: $PUBLISHED_JS_SDK_VERSION
          fi

      - name: Build package
        if: env.PUBLISH_ETHEREUM_CONTRACTS == 1 || env.PUBLISHED_JS_SDK_VERSION == 1
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Publish ethereum-contracts package
        if: env.PUBLISH_ETHEREUM_CONTRACTS == 1
        run: .github/workflows/npm-publish.sh packages/ethereum-contracts/

      - name: Publish js-sdk package
        if: env.PUBLISHED_JS_SDK_VERSION == 1
        run: .github/workflows/npm-publish.sh packages/js-sdk/
