<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2117px" preserveAspectRatio="none" style="width:846px;height:2117px;background:#FFFFFF;" version="1.1" viewBox="0 0 846 2117" width="846px" zoomAndPan="magnify"><defs><filter height="300%" id="f1nphwnmdvdyjm" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" font-weight="bold" lengthAdjust="spacing" textLength="538" x="151.5" y="31.2419">ConstantFlowAgreement: delete a flow to an MFA SuperApp</text><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1848.8888" style="stroke:#A80036;stroke-width:1.0;" width="10" x="131" y="163.2898"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1725.7707" style="stroke:#A80036;stroke-width:1.0;" width="10" x="136" y="247.7018"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="229.2361" style="stroke:#A80036;stroke-width:1.0;" width="10" x="141" y="450.2319"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="150.8241" style="stroke:#A80036;stroke-width:1.0;" width="10" x="146" y="489.9379"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="294.6481" style="stroke:#A80036;stroke-width:1.0;" width="10" x="141" y="1227.3522"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="216.2361" style="stroke:#A80036;stroke-width:1.0;" width="10" x="146" y="1267.0582"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="31.706" style="stroke:#A80036;stroke-width:1.0;" width="10" x="424" y="526.6439"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="97.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="424" y="1303.7643"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1651.3587" style="stroke:#A80036;stroke-width:1.0;" width="10" x="479" y="284.4078"/><rect fill="#AAFFFF" filter="url(#f1nphwnmdvdyjm)" height="1528.2407" style="stroke:#A80036;stroke-width:1.0;" width="10" x="484" y="368.8199"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="380.0602" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="719.174"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="494" y="795.586"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="494" y="948.4101"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="1593.4124"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="1746.2365"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="51.412" style="stroke:#000000;stroke-width:2.0;" width="360.5" x="102" y="1318.7643"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="26" x2="26" y1="129.5838" y2="2030.1786"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="136" x2="136" y1="129.5838" y2="2030.1786"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="428.5" x2="428.5" y1="129.5838" y2="2030.1786"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="483.5" x2="483.5" y1="129.5838" y2="2030.1786"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="807" x2="807" y1="129.5838" y2="2030.1786"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="5" y="125.4818">Dapp</text><ellipse cx="26" cy="53.5158" fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M26,61.5158 L26,88.5158 M13,69.5158 L39,69.5158 M26,88.5158 L13,103.5158 M26,88.5158 L39,103.5158 " fill="none" filter="url(#f1nphwnmdvdyjm)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="5" y="2044.1445">Dapp</text><ellipse cx="26" cy="2058.2465" fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M26,2066.2465 L26,2093.2465 M13,2074.2465 L39,2074.2465 M26,2093.2465 L13,2108.2465 M26,2093.2465 L39,2108.2465 " fill="none" filter="url(#f1nphwnmdvdyjm)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="44" x="112" y="91.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="119" y="113.4818">Host</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="44" x="112" y="2029.1786"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="119" y="2051.1445">Host</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="43" x="405.5" y="91.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="412.5" y="113.4818">MFA</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="43" x="405.5" y="2029.1786"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="412.5" y="2051.1445">MFA</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="39" x="462.5" y="91.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="469.5" y="113.4818">CFA</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="39" x="462.5" y="2029.1786"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="469.5" y="2051.1445">CFA</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="54" x="778" y="91.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="785" y="113.4818">Token</text><rect fill="#FEFECE" filter="url(#f1nphwnmdvdyjm)" height="33.0679" style="stroke:#A80036;stroke-width:1.5;" width="54" x="778" y="2029.1786"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="785" y="2051.1445">Token</text><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1848.8888" style="stroke:#A80036;stroke-width:1.0;" width="10" x="131" y="163.2898"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1725.7707" style="stroke:#A80036;stroke-width:1.0;" width="10" x="136" y="247.7018"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="229.2361" style="stroke:#A80036;stroke-width:1.0;" width="10" x="141" y="450.2319"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="150.8241" style="stroke:#A80036;stroke-width:1.0;" width="10" x="146" y="489.9379"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="294.6481" style="stroke:#A80036;stroke-width:1.0;" width="10" x="141" y="1227.3522"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="216.2361" style="stroke:#A80036;stroke-width:1.0;" width="10" x="146" y="1267.0582"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="31.706" style="stroke:#A80036;stroke-width:1.0;" width="10" x="424" y="526.6439"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="97.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="424" y="1303.7643"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="1651.3587" style="stroke:#A80036;stroke-width:1.0;" width="10" x="479" y="284.4078"/><rect fill="#AAFFFF" filter="url(#f1nphwnmdvdyjm)" height="1528.2407" style="stroke:#A80036;stroke-width:1.0;" width="10" x="484" y="368.8199"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="380.0602" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="719.174"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="494" y="795.586"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="494" y="948.4101"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="1593.4124"/><rect fill="#FFFFFF" filter="url(#f1nphwnmdvdyjm)" height="106.118" style="stroke:#A80036;stroke-width:1.0;" width="10" x="489" y="1746.2365"/><polygon fill="#A80036" points="119,159.2898,129,163.2898,119,167.2898,123,163.2898" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="26" x2="125" y1="163.2898" y2="163.2898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="33" y="157.4808">callAgreement</text><line style="stroke:#A80036;stroke-width:1.0;" x1="141" x2="183" y1="194.9958" y2="194.9958"/><line style="stroke:#A80036;stroke-width:1.0;" x1="183" x2="183" y1="194.9958" y2="207.9958"/><line style="stroke:#A80036;stroke-width:1.0;" x1="142" x2="183" y1="207.9958" y2="207.9958"/><polygon fill="#A80036" points="152,203.9958,142,207.9958,152,211.9958,148,207.9958" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="148" y="189.1868">_updateContext</text><line style="stroke:#A80036;stroke-width:1.0;" x1="141" x2="188" y1="234.7018" y2="234.7018"/><line style="stroke:#A80036;stroke-width:1.0;" x1="188" x2="188" y1="234.7018" y2="247.7018"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="188" y1="247.7018" y2="247.7018"/><polygon fill="#A80036" points="157,243.7018,147,247.7018,157,251.7018,153,247.7018" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="153" y="228.8928">_callExternal</text><polygon fill="#A80036" points="467,280.4078,477,284.4078,467,288.4078,471,284.4078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="146" x2="473" y1="284.4078" y2="284.4078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="153" y="278.5988">deleteFlow</text><line style="stroke:#A80036;stroke-width:1.0;" x1="489" x2="531" y1="316.1138" y2="316.1138"/><line style="stroke:#A80036;stroke-width:1.0;" x1="531" x2="531" y1="316.1138" y2="329.1138"/><line style="stroke:#A80036;stroke-width:1.0;" x1="490" x2="531" y1="329.1138" y2="329.1138"/><line style="stroke:#A80036;stroke-width:1.0;" x1="490" x2="500" y1="329.1138" y2="325.1138"/><line style="stroke:#A80036;stroke-width:1.0;" x1="490" x2="500" y1="329.1138" y2="333.1138"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="496" y="310.3048">decodeCtx</text><line style="stroke:#A80036;stroke-width:1.0;" x1="489" x2="536" y1="355.8199" y2="355.8199"/><line style="stroke:#A80036;stroke-width:1.0;" x1="536" x2="536" y1="355.8199" y2="368.8199"/><line style="stroke:#A80036;stroke-width:1.0;" x1="495" x2="536" y1="368.8199" y2="368.8199"/><polygon fill="#A80036" points="505,364.8199,495,368.8199,505,372.8199,501,368.8199" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="501" y="350.0109">_changeFlowToApp</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="536" y1="405.5259" y2="405.5259"/><line style="stroke:#A80036;stroke-width:1.0;" x1="536" x2="536" y1="405.5259" y2="418.5259"/><line style="stroke:#A80036;stroke-width:1.0;" x1="495" x2="536" y1="418.5259" y2="418.5259"/><polygon fill="#A80036" points="505,414.5259,495,418.5259,505,422.5259,501,418.5259" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243" x="501" y="399.7169">AgreementLibrary.callAppBeforeCallback</text><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="161" y1="450.2319" y2="446.2319"/><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="161" y1="450.2319" y2="454.2319"/><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="483" y1="450.2319" y2="450.2319"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="168" y="444.4229">callAppBeforeCallback</text><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="198" y1="476.9379" y2="476.9379"/><line style="stroke:#A80036;stroke-width:1.0;" x1="198" x2="198" y1="476.9379" y2="489.9379"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="198" y1="489.9379" y2="489.9379"/><polygon fill="#A80036" points="167,485.9379,157,489.9379,167,493.9379,163,489.9379" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="163" y="471.1289">_callCallback</text><line style="stroke:#A80036;stroke-width:1.0;" x1="422" x2="412" y1="526.6439" y2="522.6439"/><line style="stroke:#A80036;stroke-width:1.0;" x1="422" x2="412" y1="526.6439" y2="530.6439"/><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="423" y1="526.6439" y2="526.6439"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="163" y="520.8349">beforeAgreementTerminated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="166" y1="558.3499" y2="554.3499"/><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="166" y1="558.3499" y2="562.3499"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="156" x2="428" y1="558.3499" y2="558.3499"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="173" y="552.5409">abi.encode(oldFlowRate)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="198" y1="590.056" y2="590.056"/><line style="stroke:#A80036;stroke-width:1.0;" x1="198" x2="198" y1="590.056" y2="603.056"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="198" y1="603.056" y2="603.056"/><polygon fill="#A80036" points="167,599.056,157,603.056,167,607.056,163,603.056" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="163" y="584.247">TODO: jail if misbehaved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="156" x2="198" y1="639.762" y2="639.762"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="198" x2="198" y1="639.762" y2="652.762"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="151" x2="198" y1="652.762" y2="652.762"/><polygon fill="#A80036" points="161,648.762,151,652.762,161,656.762,157,652.762" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="163" y="633.953">(success, returnedData)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="482" x2="472" y1="679.468" y2="675.468"/><line style="stroke:#A80036;stroke-width:1.0;" x1="482" x2="472" y1="679.468" y2="683.468"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="146" x2="483" y1="679.468" y2="679.468"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="153" y="673.659">cbdata</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="541" y1="706.174" y2="706.174"/><line style="stroke:#A80036;stroke-width:1.0;" x1="541" x2="541" y1="706.174" y2="719.174"/><line style="stroke:#A80036;stroke-width:1.0;" x1="500" x2="541" y1="719.174" y2="719.174"/><polygon fill="#A80036" points="510,715.174,500,719.174,510,723.174,506,719.174" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="506" y="700.365">_changeFlow</text><polygon fill="#A80036" points="795,751.88,805,755.88,795,759.88,799,755.88" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="801" y1="755.88" y2="755.88"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="506" y="750.071">updateAgreementData</text><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="546" y1="782.586" y2="782.586"/><line style="stroke:#A80036;stroke-width:1.0;" x1="546" x2="546" y1="782.586" y2="795.586"/><line style="stroke:#A80036;stroke-width:1.0;" x1="505" x2="546" y1="795.586" y2="795.586"/><polygon fill="#A80036" points="515,791.586,505,795.586,515,799.586,511,795.586" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="511" y="776.777">_updateAccountFlowState(sender)</text><polygon fill="#A80036" points="795,828.2921,805,832.2921,795,836.2921,799,832.2921" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="504" x2="801" y1="832.2921" y2="832.2921"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="511" y="826.4831">settleBalance</text><polygon fill="#A80036" points="795,859.9981,805,863.9981,795,867.9981,799,863.9981" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="504" x2="801" y1="863.9981" y2="863.9981"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="511" y="858.1891">updateAgreementStateSlot</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="504" x2="546" y1="900.7041" y2="900.7041"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="546" x2="546" y1="900.7041" y2="913.7041"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="499" x2="546" y1="913.7041" y2="913.7041"/><polygon fill="#A80036" points="509,909.7041,499,913.7041,509,917.7041,505,913.7041" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="511" y="894.8951">newNetFlowRate</text><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="546" y1="935.4101" y2="935.4101"/><line style="stroke:#A80036;stroke-width:1.0;" x1="546" x2="546" y1="935.4101" y2="948.4101"/><line style="stroke:#A80036;stroke-width:1.0;" x1="505" x2="546" y1="948.4101" y2="948.4101"/><polygon fill="#A80036" points="515,944.4101,505,948.4101,515,952.4101,511,948.4101" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="511" y="929.6011">_updateAccountFlowState(receiver)</text><polygon fill="#A80036" points="795,981.1161,805,985.1161,795,989.1161,799,985.1161" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="504" x2="801" y1="985.1161" y2="985.1161"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="511" y="979.3071">settleBalance</text><polygon fill="#A80036" points="795,1012.8221,805,1016.8221,795,1020.8221,799,1016.8221" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="504" x2="801" y1="1016.8221" y2="1016.8221"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="511" y="1011.0131">updateAgreementStateSlot</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="504" x2="546" y1="1053.5282" y2="1053.5282"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="546" x2="546" y1="1053.5282" y2="1066.5282"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="499" x2="546" y1="1066.5282" y2="1066.5282"/><polygon fill="#A80036" points="509,1062.5282,499,1066.5282,509,1070.5282,505,1066.5282" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="511" y="1047.7192">newNetFlowRate</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="499" x2="541" y1="1098.2342" y2="1098.2342"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="541" x2="541" y1="1098.2342" y2="1111.2342"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="494" x2="541" y1="1111.2342" y2="1111.2342"/><polygon fill="#A80036" points="504,1107.2342,494,1111.2342,504,1115.2342,500,1111.2342" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="506" y="1092.4252">(depositDelta, appAllowance, newFlowData)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="536" y1="1137.9402" y2="1137.9402"/><line style="stroke:#A80036;stroke-width:1.0;" x1="536" x2="536" y1="1137.9402" y2="1150.9402"/><line style="stroke:#A80036;stroke-width:1.0;" x1="495" x2="536" y1="1150.9402" y2="1150.9402"/><polygon fill="#A80036" points="505,1146.9402,495,1150.9402,505,1154.9402,501,1150.9402" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="501" y="1132.1312">calc appAllowance*</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="536" y1="1182.6462" y2="1182.6462"/><line style="stroke:#A80036;stroke-width:1.0;" x1="536" x2="536" y1="1182.6462" y2="1195.6462"/><line style="stroke:#A80036;stroke-width:1.0;" x1="495" x2="536" y1="1195.6462" y2="1195.6462"/><polygon fill="#A80036" points="505,1191.6462,495,1195.6462,505,1199.6462,501,1195.6462" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="501" y="1176.8372">AgreementLibrary.callAppAfterCallback</text><polygon fill="#A80036" points="162,1223.3522,152,1227.3522,162,1231.3522,158,1227.3522" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="483" y1="1227.3522" y2="1227.3522"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="168" y="1221.5432">callAppAfterCallback</text><line style="stroke:#A80036;stroke-width:1.0;" x1="151" x2="198" y1="1254.0582" y2="1254.0582"/><line style="stroke:#A80036;stroke-width:1.0;" x1="198" x2="198" y1="1254.0582" y2="1267.0582"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="198" y1="1267.0582" y2="1267.0582"/><polygon fill="#A80036" points="167,1263.0582,157,1267.0582,167,1271.0582,163,1267.0582" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="163" y="1248.2492">_callCallback</text><polygon fill="#A80036" points="412,1299.7643,422,1303.7643,412,1307.7643,416,1303.7643" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="418" y1="1303.7643" y2="1303.7643"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="163" y="1297.9553">afterAgreementTerminated</text><path d="M102,1318.7643 L175,1318.7643 L175,1327.7643 L165,1337.7643 L102,1337.7643 L102,1318.7643 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="51.412" style="stroke:#000000;stroke-width:2.0;" width="360.5" x="102" y="1318.7643"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="117" y="1333.6613">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="94" x="190" y="1332.5232">[for all receivers]</text><polygon fill="#A80036" points="167,1358.1763,157,1362.1763,167,1366.1763,163,1362.1763" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="161" x2="423" y1="1362.1763" y2="1362.1763"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="173" y="1356.3673">callAgreementWithContext(deleteFlow)...</text><polygon fill="#A80036" points="167,1396.8823,157,1400.8823,167,1404.8823,163,1400.8823" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="161" x2="428" y1="1400.8823" y2="1400.8823"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="173" y="1395.0733">newCtx</text><line style="stroke:#A80036;stroke-width:1.0;" x1="156" x2="198" y1="1432.5883" y2="1432.5883"/><line style="stroke:#A80036;stroke-width:1.0;" x1="198" x2="198" y1="1432.5883" y2="1445.5883"/><line style="stroke:#A80036;stroke-width:1.0;" x1="157" x2="198" y1="1445.5883" y2="1445.5883"/><polygon fill="#A80036" points="167,1441.5883,157,1445.5883,167,1449.5883,163,1445.5883" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="163" y="1426.7793">TODO: jail if misbehaved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="156" x2="198" y1="1482.2943" y2="1482.2943"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="198" x2="198" y1="1482.2943" y2="1495.2943"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="151" x2="198" y1="1495.2943" y2="1495.2943"/><polygon fill="#A80036" points="161,1491.2943,151,1495.2943,161,1499.2943,157,1495.2943" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="163" y="1476.4853">(success, returnedData)</text><polygon fill="#A80036" points="472,1518.0004,482,1522.0004,472,1526.0004,476,1522.0004" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="146" x2="478" y1="1522.0004" y2="1522.0004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="153" y="1516.1914">cbdata</text><polygon fill="#A80036" points="795,1549.7064,805,1553.7064,795,1557.7064,799,1553.7064" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="801" y1="1553.7064" y2="1553.7064"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="501" y="1547.8974">updateAgreementData</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="541" y1="1580.4124" y2="1580.4124"/><line style="stroke:#A80036;stroke-width:1.0;" x1="541" x2="541" y1="1580.4124" y2="1593.4124"/><line style="stroke:#A80036;stroke-width:1.0;" x1="500" x2="541" y1="1593.4124" y2="1593.4124"/><polygon fill="#A80036" points="510,1589.4124,500,1593.4124,510,1597.4124,506,1593.4124" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="506" y="1574.6034">_updateAccountFlowState(sender)</text><polygon fill="#A80036" points="795,1626.1184,805,1630.1184,795,1634.1184,799,1630.1184" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="801" y1="1630.1184" y2="1630.1184"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="506" y="1624.3094">settleBalance</text><polygon fill="#A80036" points="795,1657.8244,805,1661.8244,795,1665.8244,799,1661.8244" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="801" y1="1661.8244" y2="1661.8244"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="506" y="1656.0154">updateAgreementStateSlot</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="499" x2="541" y1="1698.5304" y2="1698.5304"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="541" x2="541" y1="1698.5304" y2="1711.5304"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="494" x2="541" y1="1711.5304" y2="1711.5304"/><polygon fill="#A80036" points="504,1707.5304,494,1711.5304,504,1715.5304,500,1711.5304" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="506" y="1692.7214">newNetFlowRate</text><line style="stroke:#A80036;stroke-width:1.0;" x1="494" x2="541" y1="1733.2365" y2="1733.2365"/><line style="stroke:#A80036;stroke-width:1.0;" x1="541" x2="541" y1="1733.2365" y2="1746.2365"/><line style="stroke:#A80036;stroke-width:1.0;" x1="500" x2="541" y1="1746.2365" y2="1746.2365"/><polygon fill="#A80036" points="510,1742.2365,500,1746.2365,510,1750.2365,506,1746.2365" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="506" y="1727.4275">_updateAccountFlowState(receiver)</text><polygon fill="#A80036" points="795,1778.9425,805,1782.9425,795,1786.9425,799,1782.9425" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="801" y1="1782.9425" y2="1782.9425"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="506" y="1777.1335">settleBalance</text><polygon fill="#A80036" points="795,1810.6485,805,1814.6485,795,1818.6485,799,1814.6485" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="499" x2="801" y1="1814.6485" y2="1814.6485"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="506" y="1808.8395">updateAgreementStateSlot</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="499" x2="541" y1="1851.3545" y2="1851.3545"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="541" x2="541" y1="1851.3545" y2="1864.3545"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="494" x2="541" y1="1864.3545" y2="1864.3545"/><polygon fill="#A80036" points="504,1860.3545,494,1864.3545,504,1868.3545,500,1864.3545" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="506" y="1845.5455">newNetFlowRate</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="494" x2="536" y1="1896.0605" y2="1896.0605"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="536" x2="536" y1="1896.0605" y2="1909.0605"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="489" x2="536" y1="1909.0605" y2="1909.0605"/><polygon fill="#A80036" points="499,1905.0605,489,1909.0605,499,1913.0605,495,1909.0605" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="294" x="501" y="1890.2515">(ctx,allowanceWantedMore, allowanceUsedDelta)</text><polygon fill="#A80036" points="157,1931.7665,147,1935.7665,157,1939.7665,153,1935.7665" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="151" x2="483" y1="1935.7665" y2="1935.7665"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="294" x="163" y="1929.9575">(ctx,allowanceWantedMore, allowanceUsedDelta)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="146" x2="188" y1="1972.4726" y2="1972.4726"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188" x2="188" y1="1972.4726" y2="1985.4726"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="141" x2="188" y1="1985.4726" y2="1985.4726"/><polygon fill="#A80036" points="151,1981.4726,141,1985.4726,151,1989.4726,147,1985.4726" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="153" y="1966.6636">(success, returnedData)</text><polygon fill="#A80036" points="37,2008.1786,27,2012.1786,37,2016.1786,33,2012.1786" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="31" x2="135" y1="2012.1786" y2="2012.1786"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="43" y="2006.3696">returnedData</text><!--MD5=[c8fa54627253c10743826e9d02430abf]
@startuml

title <b>ConstantFlowAgreement: delete a flow to an MFA SuperApp</b>

actor Dapp
participant Host
participant MFA
participant CFA
participant Token

Dapp -> Host ++: callAgreement
Host -> Host: _updateContext
Host -> Host ++: _callExternal

Host -> CFA ++: deleteFlow
CFA ->> CFA: decodeCtx

CFA -> CFA ++ #aaffff: _changeFlowToApp
CFA -> CFA: AgreementLibrary.callAppBeforeCallback

CFA ->> Host ++: callAppBeforeCallback
Host -> Host ++: _callCallback
Host ->> MFA ++: beforeAgreementTerminated
return abi.encode(oldFlowRate)
Host -> Host: TODO: jail if misbehaved
return (success, returnedData)
return cbdata

CFA -> CFA ++: _changeFlow
CFA -> Token: updateAgreementData

CFA -> CFA ++: _updateAccountFlowState(sender)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

CFA -> CFA ++: _updateAccountFlowState(receiver)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

return (depositDelta, appAllowance, newFlowData) /'_changeFlow'/
CFA -> CFA: calc appAllowance*
CFA -> CFA: AgreementLibrary.callAppAfterCallback

CFA -> Host ++: callAppAfterCallback
Host -> Host ++: _callCallback
Host -> MFA ++: afterAgreementTerminated
loop for all receivers
  MFA -> Host: callAgreementWithContext(deleteFlow)...
end
return newCtx
Host -> Host: TODO: jail if misbehaved
return (success, returnedData)
return cbdata

CFA -> Token: updateAgreementData

CFA -> CFA ++: _updateAccountFlowState(sender)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

CFA -> CFA ++: _updateAccountFlowState(receiver)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

return (ctx,allowanceWantedMore, allowanceUsedDelta) /'_changeFlowToApp'/

return (ctx,allowanceWantedMore, allowanceUsedDelta) /'deleteFlow'/

return (success, returnedData) /'_callExternal'/

return returnedData /'callAgreement'/
@enduml

@startuml

title <b>ConstantFlowAgreement: delete a flow to an MFA SuperApp</b>

actor Dapp
participant Host
participant MFA
participant CFA
participant Token

Dapp -> Host ++: callAgreement
Host -> Host: _updateContext
Host -> Host ++: _callExternal

Host -> CFA ++: deleteFlow
CFA ->> CFA: decodeCtx

CFA -> CFA ++ #aaffff: _changeFlowToApp
CFA -> CFA: AgreementLibrary.callAppBeforeCallback

CFA ->> Host ++: callAppBeforeCallback
Host -> Host ++: _callCallback
Host ->> MFA ++: beforeAgreementTerminated
return abi.encode(oldFlowRate)
Host -> Host: TODO: jail if misbehaved
return (success, returnedData)
return cbdata

CFA -> CFA ++: _changeFlow
CFA -> Token: updateAgreementData

CFA -> CFA ++: _updateAccountFlowState(sender)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

CFA -> CFA ++: _updateAccountFlowState(receiver)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

return (depositDelta, appAllowance, newFlowData)
CFA -> CFA: calc appAllowance*
CFA -> CFA: AgreementLibrary.callAppAfterCallback

CFA -> Host ++: callAppAfterCallback
Host -> Host ++: _callCallback
Host -> MFA ++: afterAgreementTerminated
loop for all receivers
  MFA -> Host: callAgreementWithContext(deleteFlow)...
end
return newCtx
Host -> Host: TODO: jail if misbehaved
return (success, returnedData)
return cbdata

CFA -> Token: updateAgreementData

CFA -> CFA ++: _updateAccountFlowState(sender)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

CFA -> CFA ++: _updateAccountFlowState(receiver)
CFA -> Token: settleBalance
CFA -> Token: updateAgreementStateSlot
return newNetFlowRate

return (ctx,allowanceWantedMore, allowanceUsedDelta)

return (ctx,allowanceWantedMore, allowanceUsedDelta)

return (success, returnedData)

return returnedData
@enduml

PlantUML version 1.2021.11(Sat Oct 02 15:26:11 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
