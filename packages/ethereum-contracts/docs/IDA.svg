<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="983px" preserveAspectRatio="none" style="width:1451px;height:983px;background:#FFFFFF;" version="1.1" viewBox="0 0 1451 983" width="1451px" zoomAndPan="magnify"><defs><filter height="300%" id="f19rkk7c6ej35j" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[5342ad7228c3c218b2a4653250320d08]
cluster IDA--><rect fill="#FFFFFF" filter="url(#f19rkk7c6ej35j)" height="396" style="stroke:#000000;stroke-width:1.5;" width="1277.5" x="161.69" y="7"/><path d="M197.69,7 L197.69,16.2969 L187.69,26.2969 L161.69,26.2969 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="26" x="164.69" y="20.9951">IDA</text><!--MD5=[1ffa4d5b796394c35c3b8bac88bb7aaf]
cluster Notes--><rect fill="#FFFFFF" filter="url(#f19rkk7c6ej35j)" height="490" style="stroke:#000000;stroke-width:1.5;" width="725" x="74.19" y="443"/><path d="M130.19,443 L130.19,452.2969 L120.19,462.2969 L74.19,462.2969 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="46" x="77.19" y="456.9951">Notes</text><rect fill="#FEFECE" filter="url(#f19rkk7c6ej35j)" height="99.8125" style="stroke:#A80036;stroke-width:1.5;" width="486" x="193.69" y="69"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="242" x="315.69" y="82.1387">Account Agreement State Slots for IDA</text><line style="stroke:#A80036;stroke-width:1.0;" x1="193.69" x2="679.69" y1="86.9688" y2="86.9688"/><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="57" x="210.19" y="98.251">subsBitmap</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="112" x="288.69" y="98.251">0 : SlotsBitmap.Bitmap</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="233" x="288.69" y="109.8916">_SUBSCRIBER_SUBS_BITMAP_STATE_SLOT_ID</text><line style="stroke:#A80036;stroke-width:1.0;" x1="283.69" x2="283.69" y1="86.9688" y2="114.25"/><line style="stroke:#A80036;stroke-width:1.0;" x1="193.69" x2="679.69" y1="114.25" y2="114.25"/><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="36" x="220.69" y="125.5322">list_iIDs</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="126" x="288.69" y="125.5322">[1&lt;&lt;128..1&lt;&lt;128+255] :</text><text fill="#000000" font-family="sans-serif" font-size="10" font-weight="bold" lengthAdjust="spacing" textLength="99" x="417.69" y="125.5322">[iID | uint32.max]</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="155" x="519.69" y="125.5322">: [Maybe SlotsBitmap.SlotData]</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="251" x="288.69" y="137.1729">_SUBSCRIBER_SUB_DATA_STATE_SLOT_ID_START</text><line style="stroke:#A80036;stroke-width:1.0;" x1="283.69" x2="283.69" y1="114.25" y2="141.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="193.69" x2="679.69" y1="141.5313" y2="141.5313"/><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="80" x="198.69" y="152.8135">publisherDeposit</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="61" x="288.69" y="152.8135">1&lt;&lt;32 : uint</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="198" x="288.69" y="164.4541">_PUBLISHER_DEPOSIT_STATE_SLOT_ID</text><line style="stroke:#A80036;stroke-width:1.0;" x1="283.69" x2="283.69" y1="141.5313" y2="168.8125"/><!--MD5=[15b9a87b033c6044cf0e9bbdacb18726]
class Index--><rect codeLine="6" fill="#FEFECE" filter="url(#f19rkk7c6ej35j)" height="99.2188" id="Index" style="stroke:#A80036;stroke-width:1.5;" width="165" x="882.19" y="78"/><ellipse cx="943.94" cy="94" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M946.9087,99.6406 Q946.3306,99.9375 945.69,100.0781 Q945.0494,100.2344 944.3462,100.2344 Q941.8462,100.2344 940.5181,98.5938 Q939.2056,96.9375 939.2056,93.8125 Q939.2056,90.6875 940.5181,89.0313 Q941.8462,87.375 944.3462,87.375 Q945.0494,87.375 945.69,87.5313 Q946.3462,87.6875 946.9087,87.9844 L946.9087,90.7031 Q946.2837,90.125 945.69,89.8594 Q945.0962,89.5781 944.4712,89.5781 Q943.1275,89.5781 942.44,90.6563 Q941.7525,91.7188 941.7525,93.8125 Q941.7525,95.9063 942.44,96.9844 Q943.1275,98.0469 944.4712,98.0469 Q945.0962,98.0469 945.69,97.7813 Q946.2837,97.5 946.9087,96.9219 L946.9087,99.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="33" x="964.44" y="98.1543">Index</text><line style="stroke:#A80036;stroke-width:1.5;" x1="883.19" x2="1046.19" y1="110" y2="110"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="107" x="888.19" y="124.2104">uint128 indexValue</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="153" x="888.19" y="137.0151">uint128 totalUnitsApproved</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="145" x="888.19" y="149.8198">uint128 totalUnitsPending</text><line style="stroke:#A80036;stroke-width:1.5;" x1="883.19" x2="1046.19" y1="156.4141" y2="156.4141"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="57" x="888.19" y="170.6245">bytes iID()</text><path d="M1142.19,153.5 L1142.19,162 L1048.69,166 L1142.19,170 L1142.19,178.6328 A0,0 0 0 0 1142.19,178.6328 L1391.19,178.6328 A0,0 0 0 0 1391.19,178.6328 L1391.19,163.5 L1381.19,153.5 L1142.19,153.5 A0,0 0 0 0 1142.19,153.5 " fill="#FBFB77" filter="url(#f19rkk7c6ej35j)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1381.19,153.5 L1381.19,163.5 L1391.19,163.5 L1381.19,153.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="1148.19" y="170.5669">sha3("publisher", publisher, indexId)</text><!--MD5=[edbee5699fd167718914de6efbd8d21c]
class IndexSubscription--><rect codeLine="17" fill="#FEFECE" filter="url(#f19rkk7c6ej35j)" height="124.8281" id="IndexSubscription" style="stroke:#A80036;stroke-width:1.5;" width="219" x="855.19" y="219"/><ellipse cx="904.94" cy="235" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M907.9087,240.6406 Q907.3306,240.9375 906.69,241.0781 Q906.0494,241.2344 905.3462,241.2344 Q902.8462,241.2344 901.5181,239.5938 Q900.2056,237.9375 900.2056,234.8125 Q900.2056,231.6875 901.5181,230.0313 Q902.8462,228.375 905.3462,228.375 Q906.0494,228.375 906.69,228.5313 Q907.3462,228.6875 907.9087,228.9844 L907.9087,231.7031 Q907.2837,231.125 906.69,230.8594 Q906.0962,230.5781 905.4712,230.5781 Q904.1275,230.5781 903.44,231.6563 Q902.7525,232.7188 902.7525,234.8125 Q902.7525,236.9063 903.44,237.9844 Q904.1275,239.0469 905.4712,239.0469 Q906.0962,239.0469 906.69,238.7813 Q907.2837,238.5 907.9087,237.9219 L907.9087,240.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="111" x="925.44" y="239.1543">IndexSubscription</text><line style="stroke:#A80036;stroke-width:1.5;" x1="856.19" x2="1073.19" y1="251" y2="251"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="207" x="861.19" y="265.2104">uint32 subId # slotId in subs bitmap</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="104" x="861.19" y="278.0151">address publisher</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="79" x="861.19" y="290.8198">uint32 indexId</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="107" x="861.19" y="303.6245">uint128 indexValue</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="74" x="861.19" y="316.4292">uint128 units</text><line style="stroke:#A80036;stroke-width:1.5;" x1="856.19" x2="1073.19" y1="323.0234" y2="323.0234"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="61" x="861.19" y="337.2339">bytes sID()</text><path d="M1143.19,320.5 L1143.19,329 L1075.69,333 L1143.19,337 L1143.19,345.6328 A0,0 0 0 0 1143.19,345.6328 L1390.19,345.6328 A0,0 0 0 0 1390.19,345.6328 L1390.19,330.5 L1380.19,320.5 L1143.19,320.5 A0,0 0 0 0 1143.19,320.5 " fill="#FBFB77" filter="url(#f19rkk7c6ej35j)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1380.19,320.5 L1380.19,330.5 L1390.19,330.5 L1380.19,320.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="1149.19" y="337.5669">sha3("subscription", subscriber, iID)</text><path d="M118.19,486.5 L118.19,587.2969 L755.19,587.2969 L755.19,496.5 L745.19,486.5 L118.19,486.5 " fill="#FBFB77" filter="url(#f19rkk7c6ej35j)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M745.19,486.5 L745.19,496.5 L755.19,496.5 L745.19,486.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="124.19" y="503.5669">listSubscriptions subscriber =</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="156.19" y="518.6997">[subId...] = subsBitmap subscriber</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="392" x="156.19" y="533.8325">[iID...] = SlotsBitmapLibrary.listData [subId...]</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="156.19" y="548.9653">[sID...] = map (to_sID subscriber) [iID...]</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="584" x="156.19" y="564.0981">[subscriptions...] :: [IndexSubscription] = map getAgreementData [sID...]</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="124.19" y="579.231">]</text><path d="M98.19,622.5 L98.19,889.7578 L775.19,889.7578 L775.19,632.5 L765.19,622.5 L98.19,622.5 " fill="#FBFB77" filter="url(#f19rkk7c6ej35j)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M765.19,622.5 L765.19,632.5 L775.19,632.5 L765.19,622.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="120" x="104.19" y="639.5669">(0) bitmap =&gt; 0</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="0" x="104.19" y="654.6997"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="104.19" y="669.8325">-&gt; make first subscription</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="104.19" y="684.9653">(0) bitmap =&gt; 01</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="656" x="104.19" y="700.0981">(1&lt;&lt;128+0) =&gt; indexId of the publishder index that sbuscriber subsribes to (data0)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="104.19" y="715.231">listData -&gt; ([0], [data0])</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="0" x="104.19" y="730.3638"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="216" x="104.19" y="745.4966">-&gt; make second subscription</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="104.19" y="760.6294">(0) bitmap =&gt; 11</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="104.19" y="775.7622">(1&lt;&lt;128+0) =&gt; first publisher index (data0)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="352" x="104.19" y="790.895">(1&lt;&lt;128+1) =&gt; second publisher index (data1)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="288" x="104.19" y="806.0278">listData -&gt; ([0, 1], [data0, data1])</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="0" x="104.19" y="821.1606"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="224" x="104.19" y="836.2935">-&gt; revoke first subscription</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="104.19" y="851.4263">(0) bitmap =&gt; 10 =&gt; [1] error([0])</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="352" x="104.19" y="866.5591">(1&lt;&lt;128+1) =&gt; second publisher index (data1)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="104.19" y="881.6919">listData -&gt; ([1], [data1])</text><!--MD5=[6824fa5c5363d4c5051c9af19508ec69]
link AccountASS to Index--><path codeLine="36" d="M680.69,127 C743.4,127 813.93,127 868.89,127 " fill="none" id="AccountASS-to-Index" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="874.16,127,865.16,123,869.16,127,865.16,131,874.16,127" style="stroke:#A80036;stroke-width:1.0;"/><!--MD5=[51cb7ddbe139c9bc202f306cb4388a72]
link Notes to IDA--><!--MD5=[5f93d0dd70399a9331c3a9bccac6822d]
@startuml

left to right direction

frame IDA {
    together {
        class Index {
            bytes iID()
            uint128 indexValue
            uint128 totalUnitsApproved
            uint128 totalUnitsPending
        }
        note as iIDNote
            sha3("publisher", publisher, indexId)
        end note
        Index::iID - -> iIDNote

        class IndexSubscription {
            bytes sID()
            uint32 subId # slotId in subs bitmap
            address publisher
            uint32 indexId
            uint128 indexValue
            uint128 units
        }
        note as sIDNote
            sha3("subscription", subscriber, iID)
        end note
        IndexSubscription::sID - -> sIDNote
    }

    map "Account Agreement State Slots for IDA" as AccountASS {
        subsBitmap => 0 : SlotsBitmap.Bitmap\n_SUBSCRIBER_SUBS_BITMAP_STATE_SLOT_ID
        list_iIDs => [1<<128..1<<128+255] : **[iID | uint32.max]** : [Maybe SlotsBitmap.SlotData]\n_SUBSCRIBER_SUB_DATA_STATE_SLOT_ID_START
        publisherDeposit => 1<<32 : uint\n_PUBLISHER_DEPOSIT_STATE_SLOT_ID
    }
    AccountASS::list_iIDs - -> Index
}

frame Notes {
    note as listSubscriptions
    <code>
    listSubscriptions subscriber =
        [subId...] = subsBitmap subscriber
        [iID...] = SlotsBitmapLibrary.listData [subId...]
        [sID...] = map (to_sID subscriber) [iID...]
        [subscriptions...] :: [IndexSubscription] = map getAgreementData [sID...]
    ]
    </code>
    end note

    note as subscriptionsExample
    <code>
    (0) bitmap => 0

    -> make first subscription
    (0) bitmap => 01
    (1<<128+0) => indexId of the publishder index that sbuscriber subsribes to (data0)
    listData -> ([0], [data0])

    -> make second subscription
    (0) bitmap => 11
    (1<<128+0) => first publisher index (data0)
    (1<<128+1) => second publisher index (data1)
    listData -> ([0, 1], [data0, data1])

    -> revoke first subscription
    (0) bitmap => 10 => [1] error([0])
    (1<<128+1) => second publisher index (data1)
    listData -> ([1], [data1])
    </code>
    end note
}

Notes -left[hidden]-> IDA

@enduml

PlantUML version 1.2021.12(Tue Oct 05 19:01:58 EEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>