<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="470px" preserveAspectRatio="none" style="width:1330px;height:470px;" version="1.1" viewBox="0 0 1330 470" width="1330px" zoomAndPan="magnify"><defs><filter height="300%" id="f16rf820zpk8h" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FEFECE" filter="url(#f16rf820zpk8h)" height="60.8906" style="stroke: #A80036; stroke-width: 1.5;" width="297" x="138" y="367"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="67" x="253" y="380.1387">Subscriber</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="139" x2="434" y1="384.9688" y2="384.9688"/><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="124" x="144" y="398.251">«Agreement State Slots»</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="191" x="144" y="409.8916">[0] = subsBitmap : SlotsBitmap.Bitmap</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="285" x="144" y="421.5322">[1&lt;&lt;128..+255] = iID | uint32.max : SlotsBitmap.SlotData</text><path d="M6,8 L6,275.2578 A0,0 0 0 0 6,275.2578 L282.5,275.2578 L286.5,366.52 L290.5,275.2578 L567,275.2578 A0,0 0 0 0 567,275.2578 L567,18 L557,8 L6,8 A0,0 0 0 0 6,8 " fill="#FBFB77" filter="url(#f16rf820zpk8h)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M557,8 L557,18 L567,18 L557,8 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="12" y="25.0669">(0) bitmap =&gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="16" y="40.1997"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="12" y="55.3325">-&gt; make first subscription</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="12" y="70.4653">(0) bitmap =&gt; 01</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="540" x="12" y="85.5981">(1&lt;&lt;128+0) =&gt; indexId of the publishder index that sbuscriber subsribes to (data0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="12" y="100.731">listData -&gt; ([0], [data0])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="16" y="115.8638"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="12" y="130.9966">-&gt; make second subscription</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="12" y="146.1294">(0) bitmap =&gt; 11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="12" y="161.2622">(1&lt;&lt;128+0) =&gt; first publisher index (data0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="12" y="176.395">(1&lt;&lt;128+1) =&gt; second publisher index (data1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="12" y="191.5278">listData -&gt; ([0, 1], [data0, data1])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="16" y="206.6606"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="12" y="221.7935">-&gt; revoke first subscription</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="12" y="236.9263">(0) bitmap =&gt; 10 =&gt; [1] error([0])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="12" y="252.0591">(1&lt;&lt;128+1) =&gt; second publisher index (data1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="12" y="267.1919">listData -&gt; ([1], [data1])</text><rect fill="#FEFECE" filter="url(#f16rf820zpk8h)" height="49.25" style="stroke: #A80036; stroke-width: 1.5;" width="144" x="602.5" y="117"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="58" x="645.5" y="130.1387">Publisher</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="603.5" x2="745.5" y1="134.9688" y2="134.9688"/><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="124" x="608.5" y="148.251">«Agreement State Slots»</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="132" x="608.5" y="159.8916">[1&lt;&lt;32] : publisher deposit</text><!--class Index--><rect fill="#FEFECE" filter="url(#f16rf820zpk8h)" height="99.2188" id="Index" style="stroke: #A80036; stroke-width: 1.5;" width="242" x="781.5" y="92"/><ellipse cx="881.75" cy="108" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M884.7188,113.6406 Q884.1406,113.9375 883.5,114.0781 Q882.8594,114.2344 882.1563,114.2344 Q879.6563,114.2344 878.3281,112.5938 Q877.0156,110.9375 877.0156,107.8125 Q877.0156,104.6875 878.3281,103.0313 Q879.6563,101.375 882.1563,101.375 Q882.8594,101.375 883.5,101.5313 Q884.1563,101.6875 884.7188,101.9844 L884.7188,104.7031 Q884.0938,104.125 883.5,103.8594 Q882.9063,103.5781 882.2813,103.5781 Q880.9375,103.5781 880.25,104.6563 Q879.5625,105.7188 879.5625,107.8125 Q879.5625,109.9063 880.25,110.9844 Q880.9375,112.0469 882.2813,112.0469 Q882.9063,112.0469 883.5,111.7813 Q884.0938,111.5 884.7188,110.9219 L884.7188,113.6406 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="33" x="902.25" y="112.1543">Index</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="782.5" x2="1022.5" y1="124" y2="124"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="107" x="787.5" y="138.2104">uint128 indexValue</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="153" x="787.5" y="151.0151">uint128 totalUnitsApproved</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="145" x="787.5" y="163.8198">uint128 totalUnitsPending</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="782.5" x2="1022.5" y1="170.4141" y2="170.4141"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="230" x="787.5" y="184.6245">iID: sha3("publisher", publisher, indexId)</text><!--class IndexSubscription--><rect fill="#FEFECE" filter="url(#f16rf820zpk8h)" height="124.8281" id="IndexSubscription" style="stroke: #A80036; stroke-width: 1.5;" width="245" x="1066" y="335"/><ellipse cx="1128.75" cy="351" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1131.7188,356.6406 Q1131.1406,356.9375 1130.5,357.0781 Q1129.8594,357.2344 1129.1563,357.2344 Q1126.6563,357.2344 1125.3281,355.5938 Q1124.0156,353.9375 1124.0156,350.8125 Q1124.0156,347.6875 1125.3281,346.0313 Q1126.6563,344.375 1129.1563,344.375 Q1129.8594,344.375 1130.5,344.5313 Q1131.1563,344.6875 1131.7188,344.9844 L1131.7188,347.7031 Q1131.0938,347.125 1130.5,346.8594 Q1129.9063,346.5781 1129.2813,346.5781 Q1127.9375,346.5781 1127.25,347.6563 Q1126.5625,348.7188 1126.5625,350.8125 Q1126.5625,352.9063 1127.25,353.9844 Q1127.9375,355.0469 1129.2813,355.0469 Q1129.9063,355.0469 1130.5,354.7813 Q1131.0938,354.5 1131.7188,353.9219 L1131.7188,356.6406 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="111" x="1149.25" y="355.1543">IndexSubscription</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="1067" x2="1310" y1="367" y2="367"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="207" x="1072" y="381.2104">uint32 subId # slotId in subs bitmap</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="1072" y="394.0151">address publisher</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="79" x="1072" y="406.8198">uint32 indexId</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="107" x="1072" y="419.6245">uint128 indexValue</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="74" x="1072" y="432.4292">uint128 units</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="1067" x2="1310" y1="439.0234" y2="439.0234"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="233" x="1072" y="453.2339">sID: sha3("subscription", subscriber, iID)</text><path d="M1058.5,83.5 L1058.5,199.4297 A0,0 0 0 0 1058.5,199.4297 L1184.5,199.4297 L1188.5,334.8 L1192.5,199.4297 L1318.5,199.4297 A0,0 0 0 0 1318.5,199.4297 L1318.5,93.5 L1308.5,83.5 L1058.5,83.5 A0,0 0 0 0 1058.5,83.5 " fill="#FBFB77" filter="url(#f16rf820zpk8h)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1308.5,83.5 L1308.5,93.5 L1318.5,93.5 L1308.5,83.5 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="1064.5" y="100.5669">subscriber</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="1080.5" y="115.6997">-&gt; subsBitmap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1080.5" y="130.8325">-&gt; ([subId...], [iID...])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1080.5" y="145.9653">-&gt; [sID...]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1080.5" y="161.0981">-&gt; map getAgreementData [sID...]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1080.5" y="176.231">-&gt; [IndexSubscription...]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1064.5" y="191.3638">]</text><!--
@startuml


object Subscriber {
    «Agreement State Slots»
    [0] = subsBitmap : SlotsBitmap.Bitmap
    [1<<128..+255] = iID | uint32.max : SlotsBitmap.SlotData
}

note top of Subscriber
(0) bitmap => 0

-> make first subscription
(0) bitmap => 01
(1<<128+0) => indexId of the publishder index that sbuscriber subsribes to (data0)
listData -> ([0], [data0])

-> make second subscription
(0) bitmap => 11
(1<<128+0) => first publisher index (data0)
(1<<128+1) => second publisher index (data1)
listData -> ([0, 1], [data0, data1])

-> revoke first subscription
(0) bitmap => 10 => [1] error([0])
(1<<128+1) => second publisher index (data1)
listData -> ([1], [data1])
end note

object Publisher {
    «Agreement State Slots»
    [1<<32] : publisher deposit
}

class Index {
    iID: sha3("publisher", publisher, indexId)
    uint128 indexValue
    uint128 totalUnitsApproved
    uint128 totalUnitsPending
}

class IndexSubscription {
    sID: sha3("subscription", subscriber, iID)
    uint32 subId # slotId in subs bitmap
    address publisher
    uint32 indexId
    uint128 indexValue
    uint128 units
}

note top of IndexSubscription
subscriber
    -> subsBitmap
    -> ([subId...], [iID...])
    -> [sID...]
    -> map getAgreementData [sID...]
    -> [IndexSubscription...]
]
end note


@enduml

PlantUML version 1.2018.13(Mon Nov 26 19:11:51 EET 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.11+9-Ubuntu-0ubuntu2.20.04
Operating System: Linux
OS Version: 5.11.0-38-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>