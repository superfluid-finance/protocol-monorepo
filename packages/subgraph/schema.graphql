##################
# Event Entities #
##################
"""
Event: An interface which is shared by all
event entities and contains basic transaction
data.
"""
interface Event {
    id: ID!
    blockNumber: BigInt!
    timestamp: BigInt!
    transactionHash: Bytes!
}

#     ConstantFlowAgreementV1    #
"""
FlowUpdated: An `Event` entity that is emitted
when a flow is created, updated, or deleted.
"""
type FlowUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!

    """
    The address of the `token` being streamed.
    """
    token: Bytes!
    sender: Bytes!
    receiver: Bytes!

    """
    The flow rate per second.
    """
    flowRate: BigInt!
    totalSenderFlowRate: BigInt!
    totalReceiverFlowRate: BigInt!
    userData: Bytes!

    # Custom Properties (not on event)

    """
    The previous flow rate.
    """
    oldFlowRate: BigInt!
    """
    The "type" of the `FlowUpdated` event.
    0 = create
    1 = update
    2 = terminate
    """
    type: Int!

    """
    The total amount streamed until the timestamp
    for the Stream entity linked to this event.
    """
    totalAmountStreamedUntilTimestamp: BigInt!

    # ---------------------------------- links ----------------------------------
    """
    The stream entity which is being modified.
    """
    stream: Stream!
}

#  InstantDistributionAgreementV1 #
type IndexCreated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    publisher: Bytes!
    indexId: BigInt!
    userData: Bytes!

    # ---------------------------------- links ----------------------------------
    index: Index!
}

type IndexUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    publisher: Bytes!
    indexId: BigInt!
    oldIndexValue: BigInt!
    newIndexValue: BigInt!
    totalUnitsPending: BigInt!
    totalUnitsApproved: BigInt!
    userData: Bytes!

    # ---------------------------------- links ----------------------------------
    index: Index!
}

type SubscriptionApproved implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    publisher: Bytes!
    indexId: BigInt!
    userData: Bytes!

    # ---------------------------------- links ----------------------------------
    subscriber: Subscriber!
}

type SubscriptionRevoked implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    publisher: Bytes!
    indexId: BigInt!
    userData: Bytes!

    # ---------------------------------- links ----------------------------------
    subscriber: Subscriber!
}

type SubscriptionUnitsUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    publisher: Bytes!
    indexId: BigInt!
    units: BigInt!
    userData: Bytes!

    # ---------------------------------- links ----------------------------------
    subscriber: Subscriber!
}

#     Host    #
type GovernanceReplaced implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    oldGovernance: Bytes!
    newGovernance: Bytes!
}

type AgreementClassRegistered implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    agreementType: Bytes!
    code: Bytes!
}

type AgreementClassUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    agreementType: Bytes!
    code: Bytes!
}

type SuperTokenFactoryUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    newFactory: Bytes!
}

type SuperTokenLogicUpdated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    code: Bytes!
}

type AppRegistered implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    app: Bytes!
}

type Jail implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    app: Bytes!
    reason: BigInt!
}

# #     SuperfluidGovernance    #
type ConfigChanged implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    host: Bytes!
    superToken: Bytes!
    key: Bytes!
    isSet: Boolean! # changed from Set due to strange bug w/ TheGraph
    value: BigInt!
}

type RewardAddressChanged implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    host: Bytes!
    superToken: Bytes!
    isSet: Boolean! # changed from Set due to strange bug w/ TheGraph
    rewardAddress: Bytes!
}

type CFAv1LiquidationPeriodChanged implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    host: Bytes!
    superToken: Bytes!
    isSet: Boolean! # changed from Set due to strange bug w/ TheGraph
    liquidationPeriod: BigInt!
}

type TrustedForwarderChanged implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    host: Bytes!
    superToken: Bytes!
    isSet: Boolean! # changed from Set due to strange bug w/ TheGraph
    forwarder: Bytes!
    enabled: Boolean!
}

#     SuperToken    #
type AgreementLiquidatedBy implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    liquidatorAccount: Bytes!
    agreementClass: Bytes!
    agreementId: Bytes!
    penaltyAccount: Bytes!
    bondAccount: Bytes!
    rewardAmount: BigInt!
    bailoutAmount: BigInt!
}

type Burned implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    operator: Bytes!
    from: Bytes!
    amount: BigInt!
    data: Bytes!
    operatorData: Bytes!
}

type Minted implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    operator: Bytes!
    to: Bytes!
    amount: BigInt!
    data: Bytes!
    operatorData: Bytes!
}

type TokenUpgraded implements Event @entity {
    id: ID!
    account: Account!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    amount: BigInt!
}

type TokenDowngraded implements Event @entity {
    id: ID!
    account: Account!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
    amount: BigInt!
}

type Transfer implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    from: Account!
    to: Account!
    value: BigInt!
    token: Bytes!
}

#     SuperTokenFactory    #
type SuperTokenCreated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
}

type SuperTokenLogicCreated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    tokenLogic: Bytes!
}

type CustomSuperTokenCreated implements Event @entity {
    id: ID!
    transactionHash: Bytes!
    timestamp: BigInt!
    blockNumber: BigInt!
    token: Bytes!
}

####################
#   HOL Entities   #
####################
# State is defined as properties that will change outside
# of the BaseEntity properties.
# Links is defined as a property which links the current
# entity to another HOL entity.

"""
Account: A HOL entity created for any addresses which interact with
Superfluid contracts.
"""
type Account @entity {
    id: ID!
    createdAt: BigInt!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!

    """
    Indicates whether the address/account is a super app.
    """
    isSuperApp: Boolean!

    # ---------------------------------- links ----------------------------------
    inflows: [Stream!]! @derivedFrom(field: "receiver")
    outflows: [Stream!]! @derivedFrom(field: "sender")

    sentTransferEvents: [Transfer!]! @derivedFrom(field: "from")
    receivedTransferEvents: [Transfer!]! @derivedFrom(field: "to")

    tokenUpgradedEvents: [TokenUpgraded!]! @derivedFrom(field: "account")
    tokenDowngradedEvents: [TokenDowngraded!]! @derivedFrom(field: "account")

    accountTokenSnapshots: [AccountTokenSnapshot!]!
        @derivedFrom(field: "account")
}

"""
Token: A HOL entity created for super tokens that are "valid" (tokens that have
Superfluid's host contract address set as the host).
"""
type Token @entity {
    # Note: All Tokens are Super Tokens for this subgraph
    """
    ID: the token address
    """
    id: ID!
    createdAt: BigInt!
    name: String!
    symbol: String!
    isSuperToken: Boolean!

    """
    The address of the underlying ERC20 token.
    """
    underlyingAddress: Bytes! # Underlying ERC20
}

"""
Stream: A HOL entity that represents the lifetime of a stream between a `sender` and a `receiver`.
A account can start a stream, update the flow rate, but when they close it, it is
considered "dead". The next stream you create with the same `sender` and `receiver`
will create a new stream entity. Therefore, multiple stream entities can be created
between the same `sender` and `receiver`.
"""
type Stream @entity {
    """
    ID composed of: senderAddress-receiverAddress-tokenAddress-revisionIndex
    """
    id: ID!
    createdAt: BigInt!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!
    # ---------------------------------- state ----------------------------------
    currentFlowRate: BigInt!

    """
    The amount streamed until `updatedAtTimestamp`/`updatedAtBlock`.
    """
    streamedUntilUpdatedAt: BigInt!
    # ---------------------------------- links ----------------------------------
    token: Token!
    sender: Account!
    receiver: Account!

    flowUpdatedEvents: [FlowUpdated!]! @derivedFrom(field: "stream")
}

"""
Subscriber: A HOL entity that contains data for the `subscriber` account of a particular
`Index`.
"""
type Subscriber @entity {
    """
    ID composed of: subscriberAddress-publisherAddress-tokenAddress-IndexId
    """
    id: ID!
    createdAt: BigInt!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!
    token: Token!
    subscriber: Account!
    publisher: Account!
    indexId: BigInt!
    userData: Bytes!
    # ---------------------------------- state ----------------------------------
    """
    Approved subscribers don't need to claim tokens that are distributed from
    the publisher.
    """
    approved: Boolean!

    """
       If units is 0, it indicates that the subscription is "deleted". They are no longer
    subscribed to the index.
    """
    units: BigInt!

    """
    The total amount of tokens you've received via IDA until
    `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalAmountReceivedUntilUpdatedAt: BigInt!

    """
    The previous index value (used to calculate the `totalAmountReceivedUntilUpdatedAt` field).
    """
    lastIndexValue: BigInt!
    # ---------------------------------- links ----------------------------------
    index: Index!

    """
    Subscription approved events on the subscriber.
    """
    subscriptionApprovedEvents: [SubscriptionApproved!]!
        @derivedFrom(field: "subscriber")

    subscriptionRevokedEvents: [SubscriptionRevoked!]!
        @derivedFrom(field: "subscriber")

    subscriptionUnitsUpdatedEvents: [SubscriptionUnitsUpdated!]!
        @derivedFrom(field: "subscriber")
}

"""
Index: A Index HOL entity.
"""
type Index @entity {
    """
    ID composed of: publisherAddress-tokenAddress-IndexId
    """
    id: ID!
    createdAt: BigInt!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!
    indexId: BigInt!
    # ---------------------------------- state ----------------------------------
    userData: Bytes!
    oldIndexValue: BigInt!
    newIndexValue: BigInt!

    """
    The number of accounts subscribed to the `Index`.
    """
    totalSubscribers: Int!

    """
    The number of units allocated by the `Index` that are pending.
    """
    totalUnitsPending: BigInt!

    """
    The number of units allocated by the `Index` that are approved.
    """
    totalUnitsApproved: BigInt!

    """
    The sum of `totalUnitsPending` and `totalUnitsApproved`.
    """
    totalUnits: BigInt!

    """
    The total amount distributed from this `Index`.
    """
    totalAmountDistributedUntilUpdatedAt: BigInt!

    # ---------------------------------- links ----------------------------------
    token: Token!
    publisher: Account!

    """
    The subscribers of the index, it will include approved, unapproved
    and deleted subscribers.
    """
    subscribers: [Subscriber!]! @derivedFrom(field: "index")

    """
    IndexCreated event, there will only be one.
    """
    indexCreatedEvent: IndexCreated!

    indexUpdatedEvents: [IndexUpdated!]! @derivedFrom(field: "index")
}

####################
#  Helper Entities #
####################
type StreamRevision @entity {
    id: ID!
    revisionIndex: Int!
}

####################
#  Aggr. Entities  #
####################
"""
AccountTokenSnapshot: An aggregate entity which aggregates data on an account's
interaction with a `token`.
"""
type AccountTokenSnapshot @entity {
    """
    ID composed of: accountID-tokenID
    """
    id: ID!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!
    # ---------------------------------- state ----------------------------------
    """
    The number of currently open streams.
    """
    totalNumberOfActiveStreams: Int!

    """
    The number of all-time closed streams.
    """
    totalNumberOfClosedStreams: Int!

    """
    The number of subscriptions that this `account` has with multiple Indexes which
    are distributing the `token` on this entity.
    """
    totalSubscriptions: Int!

    """
    Similar to `totalSubscriptions`, but only counting approved subscriptions.
    """
    totalApprovedSubscriptions: Int!

    """
    Balance of `account` as of `updatedAtTimestamp`/`updatedAtBlock`.
    """
    balanceUntilUpdatedAt: BigInt!

    """
    The total net flow rate of the `account` as of `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalNetFlowRate: BigInt!

    """
    The total inflow rate (receive flowRate per second) of the `account`.
    """
    totalInflowRate: BigInt!

    """
    The total outflow rate (send flowrate per second) of the `account`.
    """
    totalOutflowRate: BigInt!

    """
    The total amount of `token` streamed to this `account` until
    the `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalAmountStreamedUntilUpdatedAt: BigInt!

    """
    The total amount of `token` this `account` has transferred.
    """
    totalAmountTransferredUntilUpdatedAt: BigInt!
    # ---------------------------------- links ----------------------------------
    account: Account!
    token: Token!
}

"""
TokenStatistic: An aggregate entity which aggregates data of a single `token`.
"""
type TokenStatistic @entity {
    """
    ID: tokenID
    """
    id: ID!
    updatedAtTimestamp: BigInt!
    updatedAtBlock: BigInt!
    # ---------------------------------- state ----------------------------------
    """
    The total number of currently active `token` streams.
    """
    totalNumberOfActiveStreams: Int!

    """
    The all-time number of closed streams.
    """
    totalNumberOfClosedStreams: Int!

    """
    The total number of Indexes created with `token`.
    """
    totalNumberOfIndexes: Int!

    """
    The total number of "active" (has greater than 0 units and has distributed it at
    least once) Indexes created with `token`.
    """
    totalNumberOfActiveIndexes: Int!

    """
    The number of subscriptions created with Indexes that distribute `token`.
    """
    totalSubscriptions: Int!

    """
    Same as `totalSubscriptions`, but only counts approved subscriptions.
    """
    totalApprovedSubscriptions: Int!

    """
    The total outflow rate of the `token` (how much value is being moved).
    """
    totalOutflowRate: BigInt!

    """
    The all-time total amount streamed until the `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalAmountStreamedUntilUpdatedAt: BigInt!

    """
    The all-time total amount transferred until the `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalAmountTransferredUntilUpdatedAt: BigInt!

    """
    The all-time total amount distributed until the `updatedAtTimestamp`/`updatedAtBlock`.
    """
    totalAmountDistributedUntilUpdatedAt: BigInt!

    """
    The total supply of the token - this is impacted by users upgrading/downgrading their
    tokens.
    """
    totalSupply: BigInt!

    # ---------------------------------- links ----------------------------------
    token: Token!
}
